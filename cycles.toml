# Flow Cycle Definitions
#
# Each cycle defines a prompt, permissions, and dependencies.
# Permissions are additive: global + per-cycle + per-step.
# Multi-iteration runs: `flow --max-iterations 10 --cycle coding`

[global]
permissions = ["Read", "Glob", "Grep", "Edit(./src/**)", "Edit(./tests/**)", "Bash(cargo *)"]

[[cycle]]
name = "coding"
description = "Plan, review plan, then implement with TDD -- three-step cycle with session affinity"
after = []
context = "summaries"

[[cycle.step]]
name = "plan"
session = "architect"
prompt = """
You are the architect for Flow's coding cycle.

Your job: read the project state and write a detailed implementation plan.

1. Read TODO.md -- identify the highest-priority unfinished task (P0 first, then P1).
2. Read AGENTS.md for architecture context and patterns.
3. Read any relevant source files for the component you'll be planning.
4. Write a clear, detailed implementation plan to .flow/current-plan.md including:
   - Which task you selected and why
   - What files need to change
   - The TDD approach (what tests to write first, then what to implement)
   - Any design decisions or trade-offs
   - Success criteria (how to verify it's done)

Do NOT write any source code. Do NOT edit src/ or tests/ files.
Write only to .flow/current-plan.md.
"""
permissions = ["Edit(./.flow/current-plan.md)"]

[[cycle.step]]
name = "plan-review"
session = "architect"
router = "llm"
max_visits = 2
prompt = """
You are the architect reviewing your own implementation plan.

1. Read .flow/current-plan.md -- the plan you just wrote.
2. Critically evaluate it:
   - Is the task selection correct (right priority)?
   - Is the plan complete and unambiguous?
   - Are the TDD steps clear?
   - Are there any risks or gaps?
3. If the plan is APPROVED: write "APPROVED" and a brief rationale to .flow/plan-review.md.
4. If the plan needs revision: write "REJECTED" with specific issues to .flow/plan-review.md.
   The router will send you back to the plan step to revise.

Be rigorous. A bad plan leads to wasted implementation effort.
"""
permissions = ["Edit(./.flow/plan-review.md)"]

[[cycle.step]]
name = "implement"
session = "coder"
prompt = """
You are Flow's coding cycle implementer. Follow the /coding-iteration skill workflow.

Before starting implementation:
1. Read .flow/current-plan.md -- this is your implementation plan. Follow it.
2. Read .flow/plan-review.md -- verify the plan was APPROVED before proceeding.

Then implement the plan using TDD:
- RED: Write failing tests first
- GREEN: Minimum code to pass tests
- REFACTOR: Clean up while tests stay green

Use the /update-todos skill before committing to keep TODO.md current.
Commit your changes when done.
"""
permissions = ["Edit(./TODO.md)", "Edit(./AGENTS.md)", "Bash(git *)"]

[[cycle]]
name = "gardening"
description = "Dependency updates, refactoring, docs, dead code removal, test coverage"
prompt = """
You are Flow's gardening cycle. Follow the /gardening skill workflow.
"""
permissions = ["Edit(./Cargo.toml)", "Bash(git *)"]
after = ["coding"]
min_interval = 5
context = "summaries"

[[cycle]]
name = "review"
description = "Goal-backward code review: verify what SHOULD be true, check wiring and completeness"
prompt = """
You are Flow's review cycle. Follow the /review skill workflow.
"""
permissions = []
after = []
min_interval = 2
context = "summaries"

[[cycle]]
name = "docs"
description = "Update user-facing documentation to reflect current features and architecture"
prompt = """
You are Flow's documentation cycle.

Your job: keep user-facing docs accurate and up-to-date with the codebase.

1. Read AGENTS.md, TODO.md, and COMPLETED.md to understand current project state.
2. Read existing docs (README.md, docs/*.md) to find gaps or stale content.
3. Read relevant source files to verify technical details.
4. Update documentation:
   - README.md: ensure it reflects current features, usage, and architecture
   - docs/*.md: create or update topic-specific docs (setup, configuration, cycle types, etc.)
5. Keep docs concise and practical. Focus on what users need to know, not internals.

Do NOT edit source code, AGENTS.md, TODO.md, or plan files.
Commit your changes when done.
"""
permissions = ["Edit(./README.md)", "Edit(./docs/**)", "Bash(git *)"]
after = ["coding"]
min_interval = 3
context = "summaries"

[[cycle]]
name = "planning"
description = "Analyze project state, prioritize TODO.md, create/refine plans"
prompt = """
You are Flow's planning cycle. Follow the /planning skill workflow.
"""
permissions = ["Edit(./TODO.md)", "Edit(./AGENTS.md)", "Edit(./plans/**)", "Bash(git *)"]
after = []
context = "full"
